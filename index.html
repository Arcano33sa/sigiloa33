<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0e" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Sigilo A33</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./assets/icon-192.png" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div id="app" class="app">
    <header class="topbar" role="banner">
      <div class="brand" aria-label="Sigilo A33">
        <img
          class="brand-logo"
          src="./assets/sigilo-a33-logo.png"
          alt=""
          width="34"
          height="34"
          onerror="this.hidden=true; this.closest('.brand').classList.add('no-logo');"
        />
        <div class="brand-title">Sigilo A33</div>
      </div>
    </header>

    <main id="main" class="main" role="main">
      <!-- ENCRIPTAR -->
      <section class="screen" data-screen="encrypt" aria-labelledby="h-encrypt">
        <h1 id="h-encrypt" class="h1">Encriptar</h1>

        <label class="label" for="encryptInput">Mensaje</label>
        <textarea id="encryptInput" class="textarea" rows="5" placeholder="Escribe tu mensaje‚Ä¶"></textarea>

        <label class="label" for="encryptContact">Contacto</label>
        <select id="encryptContact" class="select">
          <option value="" selected>Sin contactos a√∫n</option>
        </select>

        <button id="btnEncrypt" class="btn primary" type="button">Encriptar</button>

        <div class="card">
          <div class="card-title">Resultado</div>
          <textarea id="encryptResult" class="textarea mono" rows="4" readonly placeholder="Aqu√≠ aparecer√° el mensaje cifrado‚Ä¶"></textarea>
          <div class="btnrow">
            <button id="btnCopyEncrypted" class="btn" type="button">Copiar</button>
            <button id="btnShareEncrypted" class="btn" type="button">Compartir</button>
          </div>
        </div>
      </section>

      <!-- DESENCRIPTAR -->
      <section class="screen" data-screen="decrypt" aria-labelledby="h-decrypt">
        <h1 id="h-decrypt" class="h1">Desencriptar</h1>

        <label class="label" for="decryptInput">Pegar mensaje cifrado</label>
        <textarea id="decryptInput" class="textarea" rows="5" placeholder="Pega el mensaje cifrado‚Ä¶"></textarea>

        <button id="btnDecrypt" class="btn primary" type="button">Desencriptar</button>

        <div class="card">
          <div class="card-title">Resultado</div>
          <div id="decryptResult" class="mono empty">Aqu√≠ aparecer√° el texto desencriptado‚Ä¶</div>
        </div>
      </section>

      <!-- CONTACTOS -->
      <section class="screen" data-screen="contacts" aria-labelledby="h-contacts">
        <div class="row">
          <h1 id="h-contacts" class="h1">Contactos</h1>
          <button id="btnAddContact" class="btn" type="button">Agregar</button>
        </div>

        <label class="label" for="contactSearch">Buscar</label>
        <input id="contactSearch" class="input" type="search" placeholder="Nombre, apellidos o alias‚Ä¶" autocomplete="off" />

        <div class="list card">
          <div class="card-title">Lista</div>
          <div id="contactsEmpty" class="empty-state">
            <div class="empty-emoji">üóùÔ∏è</div>
            <div class="empty-title">Sin contactos todav√≠a</div>
            <div class="empty-subtitle">Agrega uno para cifrar con su clave.</div>
          </div>

          <!-- Plantilla (oculta) para el futuro -->
          <template id="contactItemTpl">
            <div class="item">
              <div class="item-main">
                <div class="item-title">Nombre Apellidos (@alias)</div>
                <div class="item-subtitle">No verificado</div>
              </div>
              <button class="btn danger" type="button" aria-label="Eliminar contacto">Eliminar</button>
            </div>
          </template>

          <div id="contactsList" class="items" hidden></div>
        </div>
      </section>

      <!-- PERFIL -->
      <section class="screen" data-screen="profile" aria-labelledby="h-profile">
        <h1 id="h-profile" class="h1">Perfil</h1>

        <div id="identityError" class="card card-error" hidden>
          <div class="card-title">Identidad</div>
          <div id="identityErrorText" class="mono">No se pudo inicializar identidad.</div>
        </div>

        <div class="grid">
          <div>
            <label class="label" for="profileName">Nombre</label>
            <input id="profileName" class="input" type="text" placeholder="Tu nombre" />
          </div>
          <div>
            <label class="label" for="profileLast">Apellidos</label>
            <input id="profileLast" class="input" type="text" placeholder="Tus apellidos" />
          </div>
          <div class="full">
            <label class="label" for="profileAlias">Alias</label>
            <input id="profileAlias" class="input" type="text" placeholder="@tu_alias" />
          </div>
        </div>

        <div class="card">
          <div class="card-title">Identidad</div>

          <div class="kv">
            <div class="k">Huella</div>
            <div id="profileFingerprint" class="mono">‚Äî</div>
          </div>

          <div class="kv">
            <div class="k">Candado p√∫blico</div>
            <div id="profileLockPreview" class="mono lock-preview empty">‚Äî</div>
          </div>

          <div class="btnrow">
            <button id="btnCopyLock" class="btn" type="button">Copiar candado</button>
            <button id="btnCopyFingerprint" class="btn" type="button">Copiar huella</button>
          </div>

          <div class="hint">La llave privada nunca se muestra. Ni aunque la invites a cenar.</div>

          <div id="buildStampProfile" class="build-stamp" aria-label="Build ID"></div>
        </div>

        <div class="card">
          <div class="row between">
            <div>
              <div class="card-title">Mi QR</div>
              <div class="muted">Comparte tu candado en formato QR (sin c√°mara por ahora).</div>
            </div>
            <button id="btnShowMyQR" class="btn" type="button">Mostrar QR</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Backup</div>
          <div class="hint hint-compact">Respaldo cifrado de <b>identidad</b> y <b>contactos</b>. Sin contrase√±a, no hay magia.</div>

          <div class="kv" style="padding-top:10px;">
            <div class="k">Exportar</div>
            <div style="flex:1;">
              <label class="label" for="backupExportPass" style="margin-top:0;">Contrase√±a</label>
              <input id="backupExportPass" class="input" type="password" placeholder="Crea una contrase√±a" autocomplete="new-password" />
              <label class="label" for="backupExportPass2">Confirmar</label>
              <input id="backupExportPass2" class="input" type="password" placeholder="Repite la contrase√±a" autocomplete="new-password" />
              <div class="btnrow" style="margin-top:10px;">
                <button id="btnExportBackup" class="btn" type="button">Exportar backup</button>
                <button id="btnCopyBackup" class="btn" type="button" disabled>Copiar</button>
              </div>
              <textarea id="backupExportOut" class="textarea mono" rows="3" readonly placeholder="Aqu√≠ saldr√° el texto cifrado del backup‚Ä¶" style="margin-top:10px; min-height:96px;"></textarea>
              <div id="backupExportErr" class="hint hint-compact danger" hidden></div>
            </div>
          </div>

          <div class="kv" style="padding-top:10px;">
            <div class="k">Importar</div>
            <div style="flex:1;">
              <input id="backupFile" type="file" accept=".txt,.backup,.a33,.sigilo" hidden />
              <div class="btnrow" style="margin-top:0;">
                <button id="btnPickBackupFile" class="btn" type="button">Subir archivo</button>
                <button id="btnPasteBackup" class="btn" type="button">Pegar</button>
              </div>

              <label class="label" for="backupImportText">Contenido</label>
              <textarea id="backupImportText" class="textarea mono" rows="3" placeholder="SIGILOA33:BACKUP:1:..."></textarea>

              <label class="label" for="backupImportPass">Contrase√±a</label>
              <input id="backupImportPass" class="input" type="password" placeholder="Contrase√±a del backup" autocomplete="current-password" />

              <button id="btnImportBackup" class="btn primary" type="button">Importar backup</button>
              <div id="backupImportErr" class="hint hint-compact danger" hidden></div>
              <div class="hint hint-compact">Si el backup trae otra identidad, se pedir√° confirmaci√≥n fuerte para reemplazar.</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <nav class="tabbar" role="navigation" aria-label="Navegaci√≥n inferior">
      <button class="tab" data-tab="encrypt" type="button">
        <span class="tab-ico">üîí</span>
        <span class="tab-txt">Encriptar</span>
      </button>
      <button class="tab" data-tab="decrypt" type="button">
        <span class="tab-ico">üîì</span>
        <span class="tab-txt">Desencriptar</span>
      </button>
      <button class="tab" data-tab="contacts" type="button">
        <span class="tab-ico">üë§</span>
        <span class="tab-txt">Contactos</span>
      </button>
      <button class="tab" data-tab="profile" type="button">
        <span class="tab-ico">‚öôÔ∏è</span>
        <span class="tab-txt">Perfil</span>
      </button>
    </nav>

    <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

    <!-- Modal: Agregar/Editar contacto (Etapa 4) -->
    <div id="contactModal" class="modal" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="contactModalTitle">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-card">
        <div class="modal-head">
          <div id="contactModalTitle" class="modal-title">Agregar contacto</div>
          <button id="btnCloseContactModal" class="iconbtn" type="button" aria-label="Cerrar">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="grid">
            <div>
              <label class="label" for="contactName">Nombre</label>
              <input id="contactName" class="input" type="text" placeholder="Nombre" autocomplete="off" />
            </div>
            <div>
              <label class="label" for="contactLast">Apellidos</label>
              <input id="contactLast" class="input" type="text" placeholder="Apellidos" autocomplete="off" />
            </div>
            <div class="full">
              <label class="label" for="contactAlias">Alias (opcional)</label>
              <input id="contactAlias" class="input" type="text" placeholder="@ana" autocomplete="off" />
            </div>
            <div class="full">
              <label class="label" for="contactQrText">Pegar texto QR</label>
              <textarea id="contactQrText" class="textarea" rows="3" placeholder="SIGILOA33:1:..."></textarea>
              <div class="btnline">
                <button id="btnScanContactQR" class="btn" type="button">Escanear QR</button>
              </div>
              <div id="contactQrError" class="hint hint-compact danger" hidden></div>
              <div class="detectbox" aria-label="Detectado">
                <div class="detectrow"><span class="k">Alias detectado</span><span id="contactDetectedAlias" class="mono">‚Äî</span></div>
                <div class="detectrow"><span class="k">Huella detectada</span><span id="contactDetectedHuella" class="mono">‚Äî</span></div>
              </div>

              <label class="checkrow" for="contactVerified">
                <input id="contactVerified" type="checkbox" />
                <span>Marcar como verificado</span>
              </label>
              <div class="hint hint-compact">Confirma la huella con la otra persona.</div>
              <div class="hint hint-compact">Si pegas un QR v√°lido, se rellena el formulario autom√°ticamente.</div>
            </div>
            <div class="full">
              <label class="label" for="contactLock">Pegar candado p√∫blico</label>
              <textarea id="contactLock" class="textarea" rows="6" placeholder="Pega aqu√≠ el candado p√∫blico‚Ä¶"></textarea>
              <div class="hint hint-compact">Se calcula la huella autom√°ticamente.</div>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button id="btnCancelContact" class="btn" type="button">Cancelar</button>
          <button id="btnSaveContact" class="btn primary" type="button">Guardar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Escanear QR (Etapa 6) -->
    <div id="scanQrModal" class="modal" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="scanQrModalTitle">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-card">
        <div class="modal-head">
          <div id="scanQrModalTitle" class="modal-title">Escanear QR</div>
          <button id="btnCloseScanQrModal" class="iconbtn" type="button" aria-label="Cerrar">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="scanwrap">
            <video id="scanQrVideo" class="scanvideo" autoplay playsinline muted></video>
          </div>
          <div id="scanQrError" class="hint hint-compact danger" hidden></div>
          <div class="hint hint-compact">Apunta la c√°mara al QR de la otra persona.</div>
        </div>
        <div class="modal-actions">
          <button id="btnScanQrPaste" class="btn" type="button">Pegar texto QR</button>
          <button id="btnScanQrCancel" class="btn" type="button">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar eliminar (Etapa 4) -->
    <div id="confirmModal" class="modal" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-card">
        <div class="modal-head">
          <div id="confirmModalTitle" class="modal-title">Eliminar</div>
          <button id="btnCloseConfirmModal" class="iconbtn" type="button" aria-label="Cerrar">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="confirmText" class="confirm-text">¬øEliminar este contacto?</div>
          <div class="hint hint-compact">Esto borra todo lo asociado a este contacto en esta app.</div>
        </div>
        <div class="modal-actions">
          <button id="btnConfirmCancel" class="btn" type="button">Cancelar</button>
          <button id="btnConfirmDelete" class="btn danger" type="button">Eliminar</button>
        </div>
      </div>
    </div>


    <!-- Modal: Mi QR (Etapa 5) -->
    <div id="myQrModal" class="modal" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="myQrModalTitle">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-card">
        <div class="modal-head">
          <div id="myQrModalTitle" class="modal-title">Mi QR</div>
          <button id="btnCloseMyQrModal" class="iconbtn" type="button" aria-label="Cerrar">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="qr-wrap">
            <div class="qr-box">
              <div id="myQrSvg" class="qr-svg" aria-label="Mi QR"></div>
              <canvas id="myQrCanvas" width="1" height="1" aria-label="Mi QR" hidden></canvas>
            </div>
          </div>

          <div id="myQrStatus" class="qr-status" hidden>‚úì Listo para escanear</div>
          <div id="myQrWarn" class="qr-warn" hidden>QR largo: si no escanea, usa Copiar texto QR</div>
          <div id="myQrBuildStamp" class="build-stamp build-stamp-qr" aria-label="Build ID"></div>
          <details id="myQrDetails" class="qr-details">
            <summary>Detalles</summary>
            <div id="myQrDetailsBody" class="qr-details-body"></div>
          </details>
          <div id="myQrErr" class="hint hint-compact danger" hidden></div>

          <div class="full" style="margin-top:12px;">
            <label class="label" for="myQrText">Texto QR</label>
            <textarea id="myQrText" class="textarea mono" rows="3" readonly></textarea>
            <div class="hint hint-compact">P√©galo en <b>Contactos</b> ‚Üí <b>Agregar</b> ‚Üí <b>Pegar texto QR</b>.</div>
          </div>
        </div>
        <div class="modal-actions">
          <button id="btnRepairCache" class="btn danger" type="button">Reparar cach√©</button>
          <button id="btnCopyMyQrText" class="btn" type="button">Copiar texto QR</button>
          <button id="btnCopyMyCandado" class="btn" type="button">Copiar candado</button>
        </div>
      </div>
    </div>

    <!-- Modal: Reemplazar identidad (Etapa 8) -->
    <div id="replaceIdentityModal" class="modal" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="replaceIdentityTitle">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-card">
        <div class="modal-head">
          <div id="replaceIdentityTitle" class="modal-title">Reemplazar identidad</div>
          <button id="btnCloseReplaceIdentityModal" class="iconbtn" type="button" aria-label="Cerrar">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="confirm-text">Esto reemplaza tu llave privada actual.</div>
          <div id="replaceIdentityInfo" class="hint hint-compact">‚Äî</div>

          <label class="label" for="replaceIdentityWord">Escribe <b>REEMPLAZAR</b> para confirmar</label>
          <input id="replaceIdentityWord" class="input" type="text" placeholder="REEMPLAZAR" autocomplete="off" autocapitalize="characters" />
          <div id="replaceIdentityErr" class="hint hint-compact danger" hidden></div>
        </div>
        <div class="modal-actions">
          <button id="btnReplaceIdentityCancel" class="btn" type="button">Cancelar</button>
          <button id="btnReplaceIdentityConfirm" class="btn danger" type="button">Reemplazar</button>
        </div>
      </div>
    </div>
  <script src="./qrcode-generator.js"></script>
  <script src="./app.js"></script>
</body>
</html>
